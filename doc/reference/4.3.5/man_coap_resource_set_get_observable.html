<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>libcoap: coap_resource_set_get_observable(3)</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">libcoap<span id="projectnumber">&#160;4.3.5</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('man_coap_resource_set_get_observable.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">coap_resource_set_get_observable(3)</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>coap_observe</title><link rel="stylesheet" type="text/css" href="docbook-xsl.css" /><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot" /></head><body><div xml:lang="en" class="refentry" lang="en"><a id="idm1"></a><div class="titlepage"></div><div class="refnamediv"><h2>NAME</h2><p><a href="man_coap_observe.html#coap_observe" target="_self">coap_observe</a>, <a href="man_coap_resource_set_get_observable.html#coap_resource_set_get_observable" target="_self"><span class="man-highlight">coap_resource_set_get_observable</span></a>, <a href="man_coap_resource_notify_observers.html#coap_resource_notify_observers" target="_self">coap_resource_notify_observers</a>, <a href="man_coap_cancel_observe.html#coap_cancel_observe" target="_self">coap_cancel_observe</a>, <a href="man_coap_session_set_no_observe_cancel.html#coap_session_set_no_observe_cancel" target="_self">coap_session_set_no_observe_cancel</a> - Work with CoAP observe </p></div><div class="refsynopsisdiv"><a id="_synopsis"></a><h2>SYNOPSIS</h2><p><span class="strong"><strong>#include &lt;coap3/coap.h&gt;</strong></span></p><p><span class="strong"><strong>void <a class="st-synopsis" href="man_coap_resource_set_get_observable.html#coap_resource_set_get_observable" target="_self"><span class="man-highlight">coap_resource_set_get_observable</span></a>(coap_resource_t *<span class="emphasis"><em>resource</em></span>,
int <span class="emphasis"><em>mode</em></span>);</strong></span></p><p><span class="strong"><strong>int <a class="st-synopsis" href="man_coap_resource_notify_observers.html#coap_resource_notify_observers" target="_self">coap_resource_notify_observers</a>(coap_resource_t *<span class="emphasis"><em>resource</em></span>,
const coap_string_t *<span class="emphasis"><em>query</em></span>);</strong></span></p><p><span class="strong"><strong>int <a class="st-synopsis" href="man_coap_cancel_observe.html#coap_cancel_observe" target="_self">coap_cancel_observe</a>(coap_session_t *<span class="emphasis"><em>session</em></span>, coap_binary_t *<span class="emphasis"><em>token</em></span>,
coap_pdu_type_t <span class="emphasis"><em>message_type</em></span>);</strong></span></p><p><span class="strong"><strong>void <a class="st-synopsis" href="man_coap_session_set_no_observe_cancel.html#coap_session_set_no_observe_cancel" target="_self">coap_session_set_no_observe_cancel</a>(coap_session_t *<span class="emphasis"><em>session</em></span>);</strong></span></p><p>For specific (D)TLS library support, link with
<span class="strong"><strong>-lcoap-3-notls</strong></span>, <span class="strong"><strong>-lcoap-3-gnutls</strong></span>,
<span class="strong"><strong>-lcoap-3-openssl</strong></span>, <span class="strong"><strong>-lcoap-3-mbedtls</strong></span>,
<span class="strong"><strong>-lcoap-3-wolfssl</strong></span>
or <span class="strong"><strong>-lcoap-3-tinydtls</strong></span>.   Otherwise, link with
<span class="strong"><strong>-lcoap-3</strong></span> to get the default (D)TLS library support.</p></div><div class="refsect1"><a id="_description"></a><h2>DESCRIPTION</h2><p><a class="ulink" href="https://rfc-editor.org/rfc/rfc7641" target="_top">RFC7641</a> extends the CoAP protocol to be
able to monitor the state of a resource over time.</p><p>This enables clients to "observe" resources with a defined query, i.e., to
retrieve a representation of a resource and keep this representation updated
by the server over a period of time.</p><p>The server has to flag a resource as "observable", and then the client has
to request in a GET request that it wants to observe this resource by the use
of the COAP_OPTION_OBSERVE Option with a value of COAP_OBSERVE_ESTABLISH.
Optionally, the client can specify query options for the resource, or by using
a FETCH request instead of a GET to define a query
(<a class="ulink" href="https://rfc-editor.org/rfc/rfc8132" target="_top">RFC8132</a>).</p><p>To remove the "observe" subscription, the client has to issue a GET (or FETCH)
request with the COAP_OPTION_OBSERVE Option with a value of
COAP_OBSERVE_CANCEL using the same token and other options used for making the
initial "observe" request. Alternatively, "observe" can be cancelled using
<span class="strong"><strong><a class="st-desc" href="man_coap_cancel_observe.html#coap_cancel_observe" target="_self">coap_cancel_observe</a></strong></span>() instead.</p><p>The underlying library adds in and removes "subscribers" to "observe" the
resource as appropriate in the server side logic.</p><p><span class="strong"><strong>NOTE:</strong></span> COAP_RESOURCE_MAX_SUBSCRIBER may have been defined to limit the number
of subscribers to a resource when libcoap was built.</p><p>Within the server application, it needs to determine that there is a change of
state of the resource under observation, and then cause the CoAP library
layer to initiate a "fake GET/FETCH request" so that an observe GET/FETCH
response gets sent back to all the clients that are observing the resource.  The
appropriate GET/FETCH handler within the server application is called to fill
in the response packet with the appropriate information. This "fake GET/FETCH
request" is triggered by a call to <span class="strong"><strong><a class="st-desc" href="man_coap_resource_notify_observers.html#coap_resource_notify_observers" target="_self">coap_resource_notify_observers</a></strong></span>().</p><p>The call to <span class="strong"><strong><a class="st-desc" href="man_coap_io_process.html#coap_io_process" target="_self">coap_io_process</a></strong></span>() in the main server application i/o loop will do
all the necessary processing of sending any outstanding "fake GET/FETCH
requests".</p><p>Whenever the server sends a copy of the state of the "observed" resource to
the client, it will use the same token used by the client when the client
requested the "observe" (or the last token used for a FETCH that spans
multiple blocks).  The client will receive this observe response
in the handler defined by <span class="strong"><strong><a class="st-desc" href="man_coap_register_response_handler.html#coap_register_response_handler" target="_self">coap_register_response_handler</a></strong></span>(3) (with the token
updated to the initial token used by the client application for a large FETCH).
It is the responsibility of the client application to match the supplied token
and update the appropriate internal information.</p></div><div class="refsect1"><a id="_functions"></a><h2>FUNCTIONS</h2><p><span class="strong"><strong><a class="anchor" id="coap_resource_set_get_observable"></a>Function: <a href="man_coap_resource_set_get_observable.html#coap_resource_set_get_observable" target="_self"><span class="man-highlight">coap_resource_set_get_observable</span></a>()</strong></span></p><p>The <span class="strong"><strong><a class="st-desc" href="man_coap_resource_set_get_observable.html#coap_resource_set_get_observable" target="_self"><span class="man-highlight">coap_resource_set_get_observable</span></a></strong></span>() function enables or disables the
observable status of the <span class="emphasis"><em>resource</em></span> by the setting of <span class="emphasis"><em>mode</em></span>.  If <span class="emphasis"><em>mode</em></span> is
1, then the <span class="emphasis"><em>resource</em></span> is observable.  If <span class="emphasis"><em>mode</em></span> is 0, then the
<span class="emphasis"><em>resource</em></span> is no longer observable.</p><p><span class="strong"><strong>NOTE:</strong></span> It is not possible for the Unknown Resource, created by
<span class="strong"><strong><a class="st-desc" href="man_coap_resource_unknown_init.html#coap_resource_unknown_init" target="_self">coap_resource_unknown_init</a></strong></span>(3), to be observable as the Uri-Path is not known
when libcoap creates a "fake GET/FETCH request".  The Unknown Resource PUT
handler must create a new resource and mark the resource as "observable" if
a specific resource needs to be observable.  The application must then
manage the deletion of the resource at the appropriate time.</p><p><span class="strong"><strong>NOTE:</strong></span> The type (confirmable or non-confirmable) of the triggered observe
GET response is determined not by the initial GET/FETCH request, but
independently by the server as per
"<a class="ulink" href="https://rfc-editor.org/rfc/rfc7641#section-3.5" target="_top">RFC7641 3.5. Transmission</a>".
This is controlled by the flags (one of COAP_RESOURCE_FLAGS_NOTIFY_NON,
COAP_RESOURCE_FLAGS_NOTIFY_NON_ALWAYS or COAP_RESOURCE_FLAGS_NOTIFY_CON)
used when creating the resource using <span class="strong"><strong><a class="st-desc" href="man_coap_resource_init.html#coap_resource_init" target="_self">coap_resource_init</a></strong></span>(3).</p><p><span class="strong"><strong>NOTE:</strong></span> Furthermore, the server must send at least one "observe" response as
confirmable, when generally sending non-confirmable, at least every 24 hours
as per "<a class="ulink" href="https://rfc-editor.org/rfc/rfc7641#section-4.5" target="_top">RFC7641
4.5. Transmission</a>".
Libcoap automatically handles this by sending every fifth (COAP_OBS_MAX_NON)
response as a confirmable response for detection that the client is still
responding unless if COAP_RESOURCE_FLAGS_NOTIFY_NON_ALWAYS is set, which is a
"<a class="ulink" href="https://rfc-editor.org/rfc/rfc7641#section-4.5" target="_top">RFC7641 4.5. Transmission</a>"
violation, where non-confirmable "observe" responses are always sent
as required by some higher layer protocols.</p><p><span class="strong"><strong>Function: <a class="st-desc" href="man_coap_resource_notify_observers.html#coap_resource_notify_observers" target="_self">coap_resource_notify_observers</a>()</strong></span></p><p>The <span class="strong"><strong><a class="st-desc" href="man_coap_resource_notify_observers.html#coap_resource_notify_observers" target="_self">coap_resource_notify_observers</a></strong></span>() function needs to be called whenever the
server application determines that there has been a change to the state of
<span class="emphasis"><em>resource</em></span>.  The <span class="emphasis"><em>query</em></span> parameter is obsolete and ignored.</p><p><span class="strong"><strong>Function: <a class="st-desc" href="man_coap_cancel_observe.html#coap_cancel_observe" target="_self">coap_cancel_observe</a>()</strong></span></p><p>The <span class="strong"><strong><a class="st-desc" href="man_coap_cancel_observe.html#coap_cancel_observe" target="_self">coap_cancel_observe</a></strong></span>() function can be used by the client to cancel an
observe request that is being tracked. This will cause the
appropriate PDU to be sent to the server to cancel the observation, based on
the <span class="emphasis"><em>session</em></span> and <span class="emphasis"><em>token</em></span> used to set up the observe and the PDU is of type
<span class="emphasis"><em>message_type</em></span> (use COAP_MESSAGE_NON or COAP_MESSAGE_CON).</p><p><span class="strong"><strong>Function: <a class="st-desc" href="man_coap_session_set_no_observe_cancel.html#coap_session_set_no_observe_cancel" target="_self">coap_session_set_no_observe_cancel</a>()</strong></span></p><p>The <span class="strong"><strong><a class="st-desc" href="man_coap_session_set_no_observe_cancel.html#coap_session_set_no_observe_cancel" target="_self">coap_session_set_no_observe_cancel</a></strong></span>() function can be called by the
client to disable calling <span class="strong"><strong><a class="st-desc" href="man_coap_cancel_observe.html#coap_cancel_observe" target="_self">coap_cancel_observe</a></strong></span>() when the <span class="emphasis"><em>session</em></span> is being
closed down / freed off. <span class="strong"><strong><a class="st-desc" href="man_coap_cancel_observe.html#coap_cancel_observe" target="_self">coap_cancel_observe</a></strong></span>() can still be called directly
by the client application.</p></div><div class="refsect1"><a id="_return_values"></a><h2>RETURN VALUES</h2><p><span class="strong"><strong><a class="st-desc" href="man_coap_resource_notify_observers.html#coap_resource_notify_observers" target="_self">coap_resource_notify_observers</a></strong></span>() returns 0 if not observable or
no observers, 1 on success.</p><p><span class="strong"><strong><a class="st-desc" href="man_coap_cancel_observe.html#coap_cancel_observe" target="_self">coap_cancel_observe</a></strong></span>() returns 0 on failure, 1 on success.</p></div><div class="refsect1"><a id="_examples"></a><h2>EXAMPLES</h2><p><span class="strong"><strong>Simple Time Server</strong></span></p><pre class="programlisting">#include &lt;coap3/coap.h&gt;

#include &lt;stdio.h&gt;

coap_resource_t *time_resource = NULL;

/* specific GET "time" handler, called from hnd_get_generic() */

static void
hnd_get_time(coap_resource_t *resource, coap_session_t *session,
             const coap_pdu_t *request, const coap_string_t *query,
             coap_pdu_t *response) {
  unsigned char buf[40];
  size_t len;
  time_t now;
  (void)resource;
  (void)session;

  /* ... Additional analysis code for resource, request pdu etc.  ... */

  /* After analysis, generate a suitable response */

  /* Note that token, if set, is already in the response pdu */

  now = time(NULL);

  if (query != NULL &amp;&amp; <a href="man_coap_string_equal.html#coap_string_equal" target="_self">coap_string_equal</a>(query, <a href="man_coap_make_str_const.html#coap_make_str_const" target="_self">coap_make_str_const</a>("secs"))) {
    /* Output secs since Jan 1 1970 */
    len = snprintf((char *)buf, sizeof(buf), "%lu", now);
  } else {
    /* Output human-readable time */
    struct tm *tmp;
    tmp = gmtime(&amp;now);
    if (!tmp) {
      /* If 'now' is not valid */
      <a href="man_coap_pdu_set_code.html#coap_pdu_set_code" target="_self">coap_pdu_set_code</a>(response, COAP_RESPONSE_CODE_NOT_FOUND);
      return;
    }
    len = strftime((char *)buf, sizeof(buf), "%b %d %H:%M:%S", tmp);
  }
  <a href="man_coap_pdu_set_code.html#coap_pdu_set_code" target="_self">coap_pdu_set_code</a>(response, COAP_RESPONSE_CODE_CONTENT);
  /*
   * Invoke <a href="man_coap_add_data_large_response.html#coap_add_data_large_response" target="_self">coap_add_data_large_response</a>() to do all the hard work.
   *
   * Define the format - COAP_MEDIATYPE_TEXT_PLAIN - to add in
   * Define how long this response is valid for (secs) - 1 - to add in.
   * ETAG Option added internally with unique value as param set to 0
   *
   * OBSERVE Option added internally if needed within the function
   * BLOCK2 Option added internally if output too large
   * SIZE2 Option added internally
   */
  <a href="man_coap_add_data_large_response.html#coap_add_data_large_response" target="_self">coap_add_data_large_response</a>(resource, session, request, response,
                               query, COAP_MEDIATYPE_TEXT_PLAIN, 1, 0,
                               len,
                               buf, NULL, NULL);
}

/* Generic GET handler */

static void
hnd_get_generic(coap_resource_t *resource, coap_session_t *session,
                const coap_pdu_t *request, const coap_string_t *query,
                coap_pdu_t *response) {
  coap_str_const_t *uri_path = <a href="man_coap_resource_get_uri_path.html#coap_resource_get_uri_path" target="_self">coap_resource_get_uri_path</a>(resource);

  if (!uri_path) {
    /* Unexpected Failure */
    <a href="man_coap_pdu_set_code.html#coap_pdu_set_code" target="_self">coap_pdu_set_code</a>(response, COAP_RESPONSE_CODE_BAD_REQUEST);
    return;
  }

  /* Is this the "time" resource" ? */
  if (<a href="man_coap_string_equal.html#coap_string_equal" target="_self">coap_string_equal</a>(uri_path, <a href="man_coap_make_str_const.html#coap_make_str_const" target="_self">coap_make_str_const</a>("time"))) {
    hnd_get_time(resource, session, request, query, response);
    return;
  }

  /* Other resources code */

  /* Failure response */
  <a href="man_coap_pdu_set_code.html#coap_pdu_set_code" target="_self">coap_pdu_set_code</a>(response, COAP_RESPONSE_CODE_BAD_REQUEST);
}

/* Initialize generic GET handler */

static void
init_resources(coap_context_t *ctx) {
  coap_resource_t *r;

  /* Create a resource to return return or update time */
  r = <a href="man_coap_resource_init.html#coap_resource_init" target="_self">coap_resource_init</a>(<a href="man_coap_make_str_const.html#coap_make_str_const" target="_self">coap_make_str_const</a>("time"),
                         COAP_RESOURCE_FLAGS_NOTIFY_CON);

  /* We are using a generic GET handler here */
  <a href="man_coap_register_request_handler.html#coap_register_request_handler" target="_self">coap_register_request_handler</a>(r, COAP_REQUEST_GET, hnd_get_generic);

  <a href="man_coap_resource_set_get_observable.html#coap_resource_set_get_observable" target="_self"><span class="man-highlight">coap_resource_set_get_observable</span></a>(r, 1);

  <a href="man_coap_add_resource.html#coap_add_resource" target="_self">coap_add_resource</a>(ctx, r);
  time_resource = r;

}

int
main(int argc, char *argv[]) {

  coap_context_t *ctx = NULL;
  coap_endpoint_t *ep = NULL;
  coap_address_t addr;
  unsigned wait_ms;
  struct timeval tv_last = {0, 0};

  /* Initialize libcoap library */
  <a href="man_coap_startup.html#coap_startup" target="_self">coap_startup</a>();

  /* Remove (void) definition if variable is used */
  (void)argc;
  (void)argv;

  memset(&amp;tv_last, 0, sizeof(tv_last));

  /* Create the libcoap context */
  ctx = <a href="man_coap_new_context.html#coap_new_context" target="_self">coap_new_context</a>(NULL);
  if (!ctx) {
    exit(1);
  }
  /* See <a href="man_coap_block.html#coap_block" target="_self">coap_block</a>(3) */
  <a href="man_coap_context_set_block_mode.html#coap_context_set_block_mode" target="_self">coap_context_set_block_mode</a>(ctx,
                              COAP_BLOCK_USE_LIBCOAP | COAP_BLOCK_SINGLE_BODY);

  <a href="man_coap_address_init.html#coap_address_init" target="_self">coap_address_init</a>(&amp;addr);
  addr.addr.sa.sa_family = AF_INET;
  addr.addr.sin.sin_port = ntohs(COAP_DEFAULT_PORT);
  ep = <a href="man_coap_new_endpoint.html#coap_new_endpoint" target="_self">coap_new_endpoint</a>(ctx, &amp;addr, COAP_PROTO_UDP);

  /* Other Set up Code */

  init_resources(ctx);

  wait_ms = COAP_RESOURCE_CHECK_TIME * 1000;

  while (1) {
    int result = <a href="man_coap_io_process.html#coap_io_process" target="_self">coap_io_process</a>(ctx, wait_ms);
    if (result &lt; 0) {
      break;
    } else if (result &amp;&amp; (unsigned)result &lt; wait_ms) {
      /* decrement if there is a result wait time returned */
      wait_ms -= result;
    } else {
      /*
       * result == 0, or result &gt;= wait_ms
       * (wait_ms could have decremented to a small value, below
       * the granularity of the timer in <a href="man_coap_io_process.html#coap_io_process" target="_self">coap_io_process</a>() and hence
       * result == 0)
       */
      wait_ms = COAP_RESOURCE_CHECK_TIME * 1000;
    }
    if (time_resource) {
      struct timeval tv_now;
      if (gettimeofday(&amp;tv_now, NULL) == 0) {
        if (tv_last.tv_sec != tv_now.tv_sec) {
          /* Happens once per second */
          tv_last = tv_now;
          <a href="man_coap_resource_notify_observers.html#coap_resource_notify_observers" target="_self">coap_resource_notify_observers</a>(time_resource, NULL);
        }
        /* need to wait until next second starts if wait_ms is too large */
        unsigned next_sec_ms = 1000 - (tv_now.tv_usec / 1000);

        if (next_sec_ms &amp;&amp; next_sec_ms &lt; wait_ms)
          wait_ms = next_sec_ms;
      }
    }
  }
  <a href="man_coap_free_context.html#coap_free_context" target="_self">coap_free_context</a>(ctx);
  <a href="man_coap_cleanup.html#coap_cleanup" target="_self">coap_cleanup</a>();
  exit(0);

}</pre><p><span class="strong"><strong>Client Observe Request Setup</strong></span></p><pre class="programlisting">#include &lt;coap3/coap.h&gt;

/* Usually, requests are sent confirmable */

static unsigned char msgtype = COAP_MESSAGE_CON;

static unsigned int token = 0;

static coap_pdu_t *
<a href="man_coap_new_request.html#coap_new_request" target="_self">coap_new_request</a>(coap_context_t *context, coap_session_t *session,
                 char request_code, coap_optlist_t **options,
                 unsigned char *data, size_t length, int observe) {
  coap_pdu_t *pdu;
  /* Remove (void) definition if variable is used */
  (void)context;

  /* Create the pdu with the appropriate options */
  pdu = <a href="man_coap_pdu_init.html#coap_pdu_init" target="_self">coap_pdu_init</a>(msgtype, request_code, <a href="man_coap_new_message_id.html#coap_new_message_id" target="_self">coap_new_message_id</a>(session),
                      <a href="man_coap_session_max_pdu_size.html#coap_session_max_pdu_size" target="_self">coap_session_max_pdu_size</a>(session));
  if (!pdu)
    return NULL;

  /*
   * Create uniqueness token for this request for handling unsolicited /
   * delayed responses
   */
  token++;
  if (!<a href="man_coap_add_token.html#coap_add_token" target="_self">coap_add_token</a>(pdu, sizeof(token), (unsigned char *)&amp;token)) {
    <a href="man_coap_log_debug.html#coap_log_debug" target="_self">coap_log_debug</a>("cannot add token to request\n");
    goto error;
  }

  if (request_code == COAP_REQUEST_GET &amp;&amp; observe) {
    /* Indicate that we want to observe this resource */
    if (!<a href="man_coap_insert_optlist.html#coap_insert_optlist" target="_self">coap_insert_optlist</a>(options,
                             <a href="man_coap_new_optlist.html#coap_new_optlist" target="_self">coap_new_optlist</a>(COAP_OPTION_OBSERVE,
                                              COAP_OBSERVE_ESTABLISH, NULL)))
      goto error;
  }

  /* ... Other code / options etc. ... */

  /* Add in all the options (after internal sorting) to the pdu */
  if (!<a href="man_coap_add_optlist_pdu.html#coap_add_optlist_pdu" target="_self">coap_add_optlist_pdu</a>(pdu, options))
    goto error;

  if (data &amp;&amp; length) {
    /* Add in the specified data */
    if (!<a href="man_coap_add_data.html#coap_add_data" target="_self">coap_add_data</a>(pdu, length, data))
      goto error;
  }

  return pdu;

error:

  <a href="man_coap_delete_pdu.html#coap_delete_pdu" target="_self">coap_delete_pdu</a>(pdu);
  return NULL;

}</pre></div><div class="refsect1"><a id="_see_also"></a><h2>SEE ALSO</h2><p><span class="strong"><strong><a class="st-desc" href="man_coap_block.html#coap_block" target="_self">coap_block</a></strong></span>(3), <span class="strong"><strong><a class="st-desc" href="man_coap_context.html#coap_context" target="_self">coap_context</a></strong></span>(3), <span class="strong"><strong><a class="st-desc" href="man_coap_handler.html#coap_handler" target="_self">coap_handler</a></strong></span>(3), <span class="strong"><strong><a class="st-desc" href="man_coap_init.html#coap_init" target="_self">coap_init</a></strong></span>(3),
<span class="strong"><strong><a class="st-desc" href="man_coap_pdu_setup.html#coap_pdu_setup" target="_self">coap_pdu_setup</a></strong></span>(3), <span class="strong"><strong><a class="st-desc" href="man_coap_resource.html#coap_resource" target="_self">coap_resource</a></strong></span>(3) and <span class="strong"><strong><a class="st-desc" href="man_coap_session.html#coap_session" target="_self">coap_session</a></strong></span>(3)</p></div><div class="refsect1"><a id="_further_information"></a><h2>FURTHER INFORMATION</h2><p>See</p><p>"<a class="ulink" href="https://rfc-editor.org/rfc/rfc7252" target="_top">RFC7252: The Constrained Application Protocol (CoAP)</a>"</p><p>"<a class="ulink" href="https://rfc-editor.org/rfc/rfc7641" target="_top">RFC7641: Observing Resources in the Constrained Application Protocol (CoAP)</a>"</p><p>"<a class="ulink" href="https://rfc-editor.org/rfc/rfc8132" target="_top">RFC8132: PATCH and FETCH Methods for the Constrained Application Protocol (CoAP)</a>"</p><p>for further information.</p></div><div class="refsect1"><a id="_bugs"></a><h2>BUGS</h2><p>Please raise an issue on GitHub at
<a class="ulink" href="https://github.com/obgm/libcoap/issues" target="_top">https://github.com/obgm/libcoap/issues</a> to report any bugs.</p><p>Please raise a Pull Request at <a class="ulink" href="https://github.com/obgm/libcoap/pulls" target="_top">https://github.com/obgm/libcoap/pulls</a>
for any fixes.</p></div><div class="refsect1"><a id="_authors"></a><h2>AUTHORS</h2><p>The libcoap project &lt;<a class="ulink" href="mailto:libcoap-developers@lists.sourceforge.net" target="_top">libcoap-developers@lists.sourceforge.net</a>&gt;</p></div></div></body></html> coap_resource_set_get_observable(3)</p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Sat Sep 7 2024 00:02:05 for libcoap by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
