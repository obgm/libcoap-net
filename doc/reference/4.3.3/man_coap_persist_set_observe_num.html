<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.4"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>libcoap: coap_persist_set_observe_num(3)</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">libcoap<span id="projectnumber">&#160;4.3.3</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.4 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('man_coap_persist_set_observe_num.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">coap_persist_set_observe_num(3) </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>coap_persist</title><link rel="stylesheet" type="text/css" href="docbook-xsl.css" /><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot" /></head><body><div xml:lang="en" class="refentry" lang="en"><a id="idm1"></a><div class="titlepage"></div><div class="refnamediv"><h2>NAME</h2><p><a href="man_coap_persist.html#coap_persist" target="_self">coap_persist</a>, <a href="man_coap_persist_startup.html#coap_persist_startup" target="_self">coap_persist_startup</a>, <a href="man_coap_persist_stop.html#coap_persist_stop" target="_self">coap_persist_stop</a>, <a href="man_coap_persist_track_funcs.html#coap_persist_track_funcs" target="_self">coap_persist_track_funcs</a>, <a href="man_coap_persist_observe_add.html#coap_persist_observe_add" target="_self">coap_persist_observe_add</a>, <a href="man_coap_persist_set_observe_num.html#coap_persist_set_observe_num" target="_self"><span class="man-highlight">coap_persist_set_observe_num</span></a> - Work with CoAP persist support </p></div><div class="refsynopsisdiv"><a id="_synopsis"></a><h2>SYNOPSIS</h2><p><span class="strong"><strong>#include &lt;coap3/coap.h&gt;</strong></span></p><p><span class="strong"><strong>int <a class="st-synopsis" href="man_coap_persist_startup.html#coap_persist_startup" target="_self">coap_persist_startup</a>(coap_context_t *<span class="emphasis"><em>context</em></span>,
const char *<span class="emphasis"><em>dyn_resource_save_file</em></span>, const char *<span class="emphasis"><em>observe_save_file</em></span>,
const char *<span class="emphasis"><em>obs_cnt_save_file</em></span>, uint32_t <span class="emphasis"><em>save_freq</em></span>);</strong></span></p><p><span class="strong"><strong>void <a class="st-synopsis" href="man_coap_persist_stop.html#coap_persist_stop" target="_self">coap_persist_stop</a>(coap_context_t *<span class="emphasis"><em>context</em></span>);</strong></span></p><p><span class="strong"><strong>void <a class="st-synopsis" href="man_coap_persist_track_funcs.html#coap_persist_track_funcs" target="_self">coap_persist_track_funcs</a>(coap_context_t *<span class="emphasis"><em>context</em></span>,
coap_observe_added_t <span class="emphasis"><em>observe_added</em></span>, coap_observe_deleted_t <span class="emphasis"><em>observe_deleted</em></span>,
coap_track_observe_value_t <span class="emphasis"><em>track_observe_value</em></span>,
coap_dyn_resource_added_t <span class="emphasis"><em>dyn_resource_added</em></span>,
coap_resource_deleted_t <span class="emphasis"><em>resource_deleted</em></span>,
uint32_t <span class="emphasis"><em>save_freq</em></span>, void *<span class="emphasis"><em>user_data</em></span>);</strong></span></p><p><span class="strong"><strong>coap_subscription_t *<a class="st-synopsis" href="man_coap_persist_observe_add.html#coap_persist_observe_add" target="_self">coap_persist_observe_add</a>(coap_context_t *<span class="emphasis"><em>context</em></span>,
coap_proto_t <span class="emphasis"><em>e_proto</em></span>, const coap_address_t *<span class="emphasis"><em>e_listen_addr</em></span>,
const coap_addr_tuple_t *<span class="emphasis"><em>s_addr_info</em></span>, const coap_bin_const_t *<span class="emphasis"><em>raw_packet</em></span>,
const coap_bin_const_t *<span class="emphasis"><em>oscore_info</em></span>);</strong></span></p><p><span class="strong"><strong>void <a class="st-synopsis" href="man_coap_persist_set_observe_num.html#coap_persist_set_observe_num" target="_self"><span class="man-highlight">coap_persist_set_observe_num</span></a>(coap_resource_t *<span class="emphasis"><em>resource</em></span>,
uint32_t <span class="emphasis"><em>start_observe_no</em></span>);</strong></span></p><p>For specific (D)TLS library support, link with
<span class="strong"><strong>-lcoap-3-notls</strong></span>, <span class="strong"><strong>-lcoap-3-gnutls</strong></span>,
<span class="strong"><strong>-lcoap-3-openssl</strong></span>, <span class="strong"><strong>-lcoap-3-mbedtls</strong></span>
or <span class="strong"><strong>-lcoap-3-tinydtls</strong></span>.   Otherwise, link with
<span class="strong"><strong>-lcoap-3</strong></span> to get the default (D)TLS library support.</p></div><div class="refsect1"><a id="_description"></a><h2>DESCRIPTION</h2><p>When a coap-server is restarted, state information does not usually persist
over the restart.  libcoap has optional compiled in support for maintaining
resources that were dynamically created, tracking ongoing observe subscriptions
and maintaining OSCORE protection.</p><p>There are callbacks provided to support doing this as an alternative persist
storage in the coap-server application.</p><p><span class="strong"><strong>NOTE:</strong></span> The observe persist support is only available for UDP sessions.</p><p>When using the libcoap compiled in support, only two functions need to be
called by the application. <span class="strong"><strong><a class="st-desc" href="man_coap_persist_startup.html#coap_persist_startup" target="_self">coap_persist_startup</a></strong></span>() defines the file names to
use for maintaining the persist information over an application restart, and
<span class="strong"><strong><a class="st-desc" href="man_coap_persist_stop.html#coap_persist_stop" target="_self">coap_persist_stop</a></strong></span>() is called to preserve any persist information over the
server restart.</p></div><div class="refsect1"><a id="_functions"></a><h2>FUNCTIONS</h2><p><span class="strong"><strong>Function: <a class="st-desc" href="man_coap_persist_startup.html#coap_persist_startup" target="_self">coap_persist_startup</a>()</strong></span></p><p>The <span class="strong"><strong><a class="st-desc" href="man_coap_persist_startup.html#coap_persist_startup" target="_self">coap_persist_startup</a></strong></span>() function is used to enable persist tracking for
<span class="emphasis"><em>context</em></span> so when a coap-server is restarted, the persist tracked information
can be added back in for the server logic.
<span class="emphasis"><em>dyn_resource_save_file</em></span> is used to save the current list of resources created
from a request to the unknown resource.
<span class="emphasis"><em>observe_save_file</em></span> is used to save the current list of active observe
subscriptions.
<span class="emphasis"><em>obs_cnt_save_file</em></span> is used to save the current observe counter used when
sending an observe unsolicited response.  <span class="emphasis"><em>obs_cnt_save_file</em></span> only gets
updated every <span class="emphasis"><em>save_freq</em></span> updates.</p><p>If any of the files exist and are not empty, when <span class="strong"><strong><a class="st-desc" href="man_coap_persist_startup.html#coap_persist_startup" target="_self">coap_persist_startup</a></strong></span>() is
called, the information is loaded back into the server logic, and for the
active observe subscriptions a new server session is created for sending out
the ongoing observe updates (UDP only supported).</p><p>If a file is defined as NULL, then that particular persist information is not
tracked by the libcoap module.  This allows a combination of
<span class="strong"><strong><a class="st-desc" href="man_coap_persist_track_funcs.html#coap_persist_track_funcs" target="_self">coap_persist_track_funcs</a></strong></span>() for customized persist tracking followed by a
call to <span class="strong"><strong><a class="st-desc" href="man_coap_persist_startup.html#coap_persist_startup" target="_self">coap_persist_startup</a></strong></span>().</p><p><span class="strong"><strong>Function: <a class="st-desc" href="man_coap_persist_stop.html#coap_persist_stop" target="_self">coap_persist_stop</a>()</strong></span></p><p>The <span class="strong"><strong><a class="st-desc" href="man_coap_persist_stop.html#coap_persist_stop" target="_self">coap_persist_stop</a></strong></span>() function is used to disable any current persist
tracking as set up by <span class="strong"><strong><a class="st-desc" href="man_coap_persist_startup.html#coap_persist_startup" target="_self">coap_persist_startup</a></strong></span>() for <span class="emphasis"><em>context</em></span> and preserve the
tracking for when the coap-server application restarts.</p><p>If using <span class="strong"><strong><a class="st-desc" href="man_coap_persist_track_funcs.html#coap_persist_track_funcs" target="_self">coap_persist_track_funcs</a></strong></span>(), then calling <span class="strong"><strong><a class="st-desc" href="man_coap_persist_stop.html#coap_persist_stop" target="_self">coap_persist_stop</a></strong></span>()
will stop any 4.04 unsolicited response messages being sent when a
resource that has an active observe subscription is deleted (as happens
when <span class="strong"><strong><a class="st-desc" href="man_coap_free_context.html#coap_free_context" target="_self">coap_free_context</a></strong></span>() is subsequentially called).</p><p><span class="strong"><strong>Function: <a class="st-desc" href="man_coap_persist_track_funcs.html#coap_persist_track_funcs" target="_self">coap_persist_track_funcs</a>()</strong></span></p><p>The <span class="strong"><strong><a class="st-desc" href="man_coap_persist_track_funcs.html#coap_persist_track_funcs" target="_self">coap_persist_track_funcs</a></strong></span>() function is used to setup callback functions
associated with <span class="emphasis"><em>context</em></span> that track information so that the current tracked
information state can be rebuilt following a server application restart. It is
the responsibility of the server application to track the appropriate
information.</p><p>The <span class="emphasis"><em>observe_added</em></span> callback function prototype, called when a client
subscribes to a resource for observation, is defined as:</p><pre class="programlisting">typedef int (*coap_observe_added_t)(coap_session_t *session,
                                    coap_subscription_t *observe_key,
                                    coap_proto_t e_proto,
                                    coap_address_t *e_listen_addr,
                                    coap_addr_tuple_t *s_addr_info,
                                    coap_bin_const_t *raw_packet,
                                    coap_bin_const_t *oscore_info,
                                    void *user_data);</pre><p>The <span class="emphasis"><em>observe_deleted</em></span> callback function prototype, called when a client
removes the subscription to a resource for observation, is defined as:</p><pre class="programlisting">typedef int (*coap_observe_deleted_t)(coap_session_t *session,
                                      coap_subscription_t *observe_key,
                                      void *user_data);</pre><p>The <span class="emphasis"><em>track_observe_value</em></span> callback function prototype, called when a new
unsolicited observe response is went (every <span class="emphasis"><em>save_freq</em></span>), is defined as:</p><pre class="programlisting">typedef int (*coap_track_observe_value_t)(coap_context_t *context,
                                          coap_str_const_t *resource_name,
                                          uint32_t observe_num,
                                          void *user_data);</pre><p>The <span class="emphasis"><em>dyn_resource_added</em></span> callback function prototype, called whenever a
resource is created from a request that is calling the resource unknown
handler, is defined as:</p><pre class="programlisting">typedef int (*coap_dyn_resource_added_t)(coap_session_t *session,
                                         coap_str_const_t *resource_name,
                                         coap_bin_const_t *raw_packet,
                                         void *user_data);</pre><p>The <span class="emphasis"><em>resource_deleted</em></span> callback function prototype, called whenever a
resource is deleted, is defined as:</p><pre class="programlisting">typedef int (*coap_resource_deleted_t)(coap_context_t *context,
                                       coap_str_const_t *resource_name,
                                       void *user_data);</pre><p><span class="emphasis"><em>save_freq</em></span> defines the frequency of the update to the observe value when
libcoap calls <span class="emphasis"><em>track_observe_value</em></span>. <span class="emphasis"><em>user_data</em></span> is application defined and
is passed into all of the callback handlers.</p><p><span class="strong"><strong>Function: <a class="st-desc" href="man_coap_persist_observe_add.html#coap_persist_observe_add" target="_self">coap_persist_observe_add</a>()</strong></span></p><p>The <span class="strong"><strong><a class="st-desc" href="man_coap_persist_observe_add.html#coap_persist_observe_add" target="_self">coap_persist_observe_add</a></strong></span>() function is used to set up a session and a
observe subscription request (typically following a server reboot) so that a
client can continue to receive unsolicited observe responses without having
to establish a new session and issue a new observe subscription request. The
new session is associated with the endpoint defined by <span class="emphasis"><em>e_proto</em></span> and
<span class="emphasis"><em>e_listen_address</em></span>.  The session has the IP addresses as defined by
<span class="emphasis"><em>s_addr_info</em></span>. <span class="emphasis"><em>raw_packet</em></span> contains the layer 7 of the IP packet that was
originally used to request the observe subscription. Optional <span class="emphasis"><em>oscore_info</em></span>
defines the OSCORE information if packets are protected by OSCORE.
 <span class="emphasis"><em>e_proto</em></span>, <span class="emphasis"><em>e_listen_addr</em></span>, <span class="emphasis"><em>s_addr_info</em></span>, <span class="emphasis"><em>raw_packet</em></span> and <span class="emphasis"><em>oscore_info</em></span>
are the same as passed into the <span class="emphasis"><em>coap_observe_added_t</em></span> callback.</p><p><span class="strong"><strong><a class="anchor" id="coap_persist_set_observe_num"></a>Function: <a href="man_coap_persist_set_observe_num.html#coap_persist_set_observe_num" target="_self"><span class="man-highlight">coap_persist_set_observe_num</span></a>()</strong></span></p><p>The <span class="strong"><strong><a class="st-desc" href="man_coap_persist_set_observe_num.html#coap_persist_set_observe_num" target="_self"><span class="man-highlight">coap_persist_set_observe_num</span></a></strong></span>() function is used to update the
<span class="emphasis"><em>resource</em></span>'s current observe counter to start from <span class="emphasis"><em>start_observe_no</em></span>
instead of 0,</p></div><div class="refsect1"><a id="_return_values"></a><h2>RETURN VALUES</h2><p><span class="strong"><strong><a class="st-desc" href="man_coap_persist_startup.html#coap_persist_startup" target="_self">coap_persist_startup</a></strong></span>() returns 1 on success else 0.</p><p><span class="strong"><strong><a class="st-desc" href="man_coap_persist_observe_add.html#coap_persist_observe_add" target="_self">coap_persist_observe_add</a></strong></span>() returns a newly created observe
subscription or NULL on failure.</p></div><div class="refsect1"><a id="_examples"></a><h2>EXAMPLES</h2><p><span class="strong"><strong>Simple Time Server</strong></span></p><pre class="programlisting">#include &lt;coap3/coap.h&gt;

#include &lt;stdio.h&gt;

coap_resource_t *time_resource = NULL;

/* specific GET "time" handler, called from hnd_get_generic() */

static void
hnd_get_time(coap_resource_t *resource, coap_session_t *session,
const coap_pdu_t *request, const coap_string_t *query, coap_pdu_t *response) {

  unsigned char buf[40];
  size_t len;
  time_t now;
  (void)resource;
  (void)session;

  /* ... Additional analysis code for resource, request pdu etc.  ... */

  /* After analysis, generate a suitable response */

  /* Note that token, if set, is already in the response pdu */

  now = time(NULL);

  if (query != NULL &amp;&amp; <a href="man_coap_string_equal.html#coap_string_equal" target="_self">coap_string_equal</a>(query, <a href="man_coap_make_str_const.html#coap_make_str_const" target="_self">coap_make_str_const</a>("secs"))) {
    /* Output secs since Jan 1 1970 */
    len = snprintf((char *)buf, sizeof(buf), "%lu", now);
  }
  else {
    /* Output human-readable time */
    struct tm *tmp;
    tmp = gmtime(&amp;now);
    if (!tmp) {
      /* If 'now' is not valid */
      <a href="man_coap_pdu_set_code.html#coap_pdu_set_code" target="_self">coap_pdu_set_code</a>(response, COAP_RESPONSE_CODE_NOT_FOUND);
      return;
    }
    len = strftime((char *)buf, sizeof(buf), "%b %d %H:%M:%S", tmp);
  }
  <a href="man_coap_pdu_set_code.html#coap_pdu_set_code" target="_self">coap_pdu_set_code</a>(response, COAP_RESPONSE_CODE_CONTENT);
  /*
   * Invoke <a href="man_coap_add_data_large_response.html#coap_add_data_large_response" target="_self">coap_add_data_large_response</a>() to do all the hard work.
   *
   * Define the format - COAP_MEDIATYPE_TEXT_PLAIN - to add in
   * Define how long this response is valid for (secs) - 1 - to add in.
   * ETAG Option added internally with unique value as param set to 0
   *
   * OBSERVE Option added internally if needed within the function
   * BLOCK2 Option added internally if output too large
   * SIZE2 Option added internally
   */
  <a href="man_coap_add_data_large_response.html#coap_add_data_large_response" target="_self">coap_add_data_large_response</a>(resource, session, request, response,
                               query, COAP_MEDIATYPE_TEXT_PLAIN, 1, 0,
                               len,
                               buf, NULL, NULL);
}

/* Generic GET handler */

static void
hnd_get_generic(coap_resource_t *resource, coap_session_t *session,
const coap_pdu_t *request, const coap_string_t *query, coap_pdu_t *response) {

  coap_str_const_t *uri_path = <a href="man_coap_resource_get_uri_path.html#coap_resource_get_uri_path" target="_self">coap_resource_get_uri_path</a>(resource);

  if (!uri_path) {
    /* Unexpected Failure */
    <a href="man_coap_pdu_set_code.html#coap_pdu_set_code" target="_self">coap_pdu_set_code</a>(response, COAP_RESPONSE_CODE_BAD_REQUEST);
    return;
  }

  /* Is this the "time" resource" ? */
  if (<a href="man_coap_string_equal.html#coap_string_equal" target="_self">coap_string_equal</a>(uri_path, <a href="man_coap_make_str_const.html#coap_make_str_const" target="_self">coap_make_str_const</a>("time"))) {
    hnd_get_time(resource, session, request, query, response);
    return;
  }

  /* Other resources code */

  /* Failure response */
  <a href="man_coap_pdu_set_code.html#coap_pdu_set_code" target="_self">coap_pdu_set_code</a>(response, COAP_RESPONSE_CODE_BAD_REQUEST);
}

/* Initialize generic GET handler */

static void
init_resources(coap_context_t *ctx)
{

  coap_resource_t *r;

  /* Create a resource to return return or update time */
  r = <a href="man_coap_resource_init.html#coap_resource_init" target="_self">coap_resource_init</a>(<a href="man_coap_make_str_const.html#coap_make_str_const" target="_self">coap_make_str_const</a>("time"),
                         COAP_RESOURCE_FLAGS_NOTIFY_CON);

  /* We are using a generic GET handler here */
  <a href="man_coap_register_request_handler.html#coap_register_request_handler" target="_self">coap_register_request_handler</a>(r, COAP_REQUEST_GET, hnd_get_generic);

  <a href="man_coap_resource_set_get_observable.html#coap_resource_set_get_observable" target="_self">coap_resource_set_get_observable</a>(r, 1);

  <a href="man_coap_add_resource.html#coap_add_resource" target="_self">coap_add_resource</a>(ctx, r);
  time_resource = r;

}

int
main(int argc, char *argv[]) {

  coap_context_t *ctx = NULL;
  coap_endpoint_t *ep = NULL;
  coap_address_t addr;
  unsigned wait_ms;
  struct timeval tv_last = {0, 0};
  /* Remove (void) definition if variable is used */
  (void)argc;
  (void)argv;

  /* Initialize libcoap library */
  <a href="man_coap_startup.html#coap_startup" target="_self">coap_startup</a>();

  memset (&amp;tv_last, 0, sizeof(tv_last));

  /* Create the libcoap context */
  ctx = <a href="man_coap_new_context.html#coap_new_context" target="_self">coap_new_context</a>(NULL);
  if (!ctx) {
    exit(1);
  }
  /* See <a href="man_coap_block.html#coap_block" target="_self">coap_block</a>(3) */
  <a href="man_coap_context_set_block_mode.html#coap_context_set_block_mode" target="_self">coap_context_set_block_mode</a>(ctx,
                              COAP_BLOCK_USE_LIBCOAP | COAP_BLOCK_SINGLE_BODY);

  <a href="man_coap_address_init.html#coap_address_init" target="_self">coap_address_init</a>(&amp;addr);
  addr.addr.sa.sa_family = AF_INET;
  addr.addr.sin.sin_port = ntohs(COAP_DEFAULT_PORT);
  ep = <a href="man_coap_new_endpoint.html#coap_new_endpoint" target="_self">coap_new_endpoint</a>(ctx, &amp;addr, COAP_PROTO_UDP);

  /* Other Set up Code */

  init_resources(ctx);

  if (!<a href="man_coap_persist_startup.html#coap_persist_startup" target="_self">coap_persist_startup</a>(ctx,
                            "/tmp/coap_dyn_resource_save_file",
                            "/tmp/coap_observe_save_file",
                            "/tmp/coap_obs_cnt_save_file", 10)) {
    fprintf(stderr, "Unable to set up persist logic\n");
    exit(1);
  }

  wait_ms = COAP_RESOURCE_CHECK_TIME * 1000;

  while (1) {
    int result = <a href="man_coap_io_process.html#coap_io_process" target="_self">coap_io_process</a>( ctx, wait_ms );
    if ( result &lt; 0 ) {
      break;
    } else if ( result &amp;&amp; (unsigned)result &lt; wait_ms ) {
      /* decrement if there is a result wait time returned */
      wait_ms -= result;
    } else {
      /*
       * result == 0, or result &gt;= wait_ms
       * (wait_ms could have decremented to a small value, below
       * the granularity of the timer in <a href="man_coap_io_process.html#coap_io_process" target="_self">coap_io_process</a>() and hence
       * result == 0)
       */
      wait_ms = COAP_RESOURCE_CHECK_TIME * 1000;
    }
    if (time_resource) {
      struct timeval tv_now;
      if (gettimeofday (&amp;tv_now, NULL) == 0) {
        if (tv_last.tv_sec != tv_now.tv_sec) {
          /* Happens once per second */
          tv_last = tv_now;
          <a href="man_coap_resource_notify_observers.html#coap_resource_notify_observers" target="_self">coap_resource_notify_observers</a>(time_resource, NULL);
        }
        /* need to wait until next second starts if wait_ms is too large */
        unsigned next_sec_ms = 1000 - (tv_now.tv_usec / 1000);

        if (next_sec_ms &amp;&amp; next_sec_ms &lt; wait_ms)
          wait_ms = next_sec_ms;
      }
    }
  }
  <a href="man_coap_persist_stop.html#coap_persist_stop" target="_self">coap_persist_stop</a>(ctx);
  <a href="man_coap_free_context.html#coap_free_context" target="_self">coap_free_context</a>(ctx);
  <a href="man_coap_cleanup.html#coap_cleanup" target="_self">coap_cleanup</a>();
  exit(0);

}</pre></div><div class="refsect1"><a id="_see_also"></a><h2>SEE ALSO</h2><p><span class="strong"><strong><a class="st-desc" href="man_coap_block.html#coap_block" target="_self">coap_block</a></strong></span>(3), <span class="strong"><strong><a class="st-desc" href="man_coap_context.html#coap_context" target="_self">coap_context</a></strong></span>(3), <span class="strong"><strong><a class="st-desc" href="man_coap_handler.html#coap_handler" target="_self">coap_handler</a></strong></span>(3), <span class="strong"><strong><a class="st-desc" href="man_coap_init.html#coap_init" target="_self">coap_init</a></strong></span>(3), <span class="strong"><strong><a class="st-desc" href="man_coap_observe.html#coap_observe" target="_self">coap_observe</a></strong></span>(3),
<span class="strong"><strong><a class="st-desc" href="man_coap_pdu_setup.html#coap_pdu_setup" target="_self">coap_pdu_setup</a></strong></span>(3), <span class="strong"><strong><a class="st-desc" href="man_coap_resource.html#coap_resource" target="_self">coap_resource</a></strong></span>(3) and <span class="strong"><strong><a class="st-desc" href="man_coap_session.html#coap_session" target="_self">coap_session</a></strong></span>(3)</p></div><div class="refsect1"><a id="_further_information"></a><h2>FURTHER INFORMATION</h2><p>See</p><p>"<a class="ulink" href="https://rfc-editor.org/rfc/rfc7252" target="_top">RFC7252: The Constrained Application Protocol (CoAP)</a>"</p><p>"<a class="ulink" href="https://rfc-editor.org/rfc/rfc7641" target="_top">RFC7641: Observing Resources in the Constrained Application Protocol (CoAP)</a>"</p><p>"<a class="ulink" href="https://rfc-editor.org/rfc/rfc8613" target="_top">RFC8613: Object Security for Constrained RESTful Environments (OSCORE)</a>"</p><p>for further information.</p></div><div class="refsect1"><a id="_bugs"></a><h2>BUGS</h2><p>Please report bugs on the mailing list for libcoap:
<a class="ulink" href="mailto:libcoap-developers@lists.sourceforge.net" target="_top">libcoap-developers@lists.sourceforge.net</a> or raise an issue on GitHub at
<a class="ulink" href="https://github.com/obgm/libcoap/issues" target="_top">https://github.com/obgm/libcoap/issues</a></p></div><div class="refsect1"><a id="_authors"></a><h2>AUTHORS</h2><p>The libcoap project &lt;<a class="ulink" href="mailto:libcoap-developers@lists.sourceforge.net" target="_top">libcoap-developers@lists.sourceforge.net</a>&gt;</p></div></div></body></html> coap_persist_set_observe_num(3)</p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Thu Sep 14 2023 12:43:42 for libcoap by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.4 </li>
  </ul>
</div>
</body>
</html>
