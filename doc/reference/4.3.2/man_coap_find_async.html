<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.4"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>libcoap: coap_find_async(3)</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">libcoap<span id="projectnumber">&#160;4.3.2</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.4 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('man_coap_find_async.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">coap_find_async(3) </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>coap_async</title><link rel="stylesheet" type="text/css" href="docbook-xsl.css" /><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot" /></head><body><div xml:lang="en" class="refentry" lang="en"><a id="idm1"></a><div class="titlepage"></div><div class="refnamediv"><h2>NAME</h2><p><a href="man_coap_async.html#coap_async" target="_self">coap_async</a>, <a href="man_coap_async_is_supported.html#coap_async_is_supported" target="_self">coap_async_is_supported</a>, <a href="man_coap_register_async.html#coap_register_async" target="_self">coap_register_async</a>, <a href="man_coap_async_trigger.html#coap_async_trigger" target="_self">coap_async_trigger</a>, <a href="man_coap_async_set_delay.html#coap_async_set_delay" target="_self">coap_async_set_delay</a>, <a href="man_coap_find_async.html#coap_find_async" target="_self"><span class="man-highlight">coap_find_async</span></a>, <a href="man_coap_free_async.html#coap_free_async" target="_self">coap_free_async</a>, <a href="man_coap_async_set_app_data.html#coap_async_set_app_data" target="_self">coap_async_set_app_data</a>, <a href="man_coap_async_get_app_data.html#coap_async_get_app_data" target="_self">coap_async_get_app_data</a> - Work with CoAP async support </p></div><div class="refsynopsisdiv"><a id="_synopsis"></a><h2>SYNOPSIS</h2><p><span class="strong"><strong>#include &lt;coap3/coap.h&gt;</strong></span></p><p><span class="strong"><strong>int <a class="st-synopsis" href="man_coap_async_is_supported.html#coap_async_is_supported" target="_self">coap_async_is_supported</a>(void);</strong></span></p><p><span class="strong"><strong>coap_async_t *<a class="st-synopsis" href="man_coap_register_async.html#coap_register_async" target="_self">coap_register_async</a>(coap_session_t *<span class="emphasis"><em>session</em></span>,
const coap_pdu_t *<span class="emphasis"><em>request</em></span>, coap_tick_t <span class="emphasis"><em>delay</em></span>);</strong></span></p><p><span class="strong"><strong>void <a class="st-synopsis" href="man_coap_async_trigger.html#coap_async_trigger" target="_self">coap_async_trigger</a>(coap_async_t *<span class="emphasis"><em>async</em></span>);</strong></span></p><p><span class="strong"><strong>void <a class="st-synopsis" href="man_coap_async_set_delay.html#coap_async_set_delay" target="_self">coap_async_set_delay</a>(coap_async_t *<span class="emphasis"><em>async</em></span>, coap_tick_t <span class="emphasis"><em>delay</em></span>);</strong></span></p><p><span class="strong"><strong>void <a class="st-synopsis" href="man_coap_free_async.html#coap_free_async" target="_self">coap_free_async</a>(coap_session_t *<span class="emphasis"><em>session</em></span>, coap_async_t *<span class="emphasis"><em>async</em></span>);</strong></span></p><p><span class="strong"><strong>coap_async_t *<a class="st-synopsis" href="man_coap_find_async.html#coap_find_async" target="_self"><span class="man-highlight">coap_find_async</span></a>(coap_session_t *<span class="emphasis"><em>session</em></span>,
coap_bin_const_t <span class="emphasis"><em>token</em></span>);</strong></span></p><p><span class="strong"><strong>void <a class="st-synopsis" href="man_coap_async_set_app_data.html#coap_async_set_app_data" target="_self">coap_async_set_app_data</a>(coap_async_t *<span class="emphasis"><em>async</em></span>, void *<span class="emphasis"><em>app_data</em></span>);</strong></span></p><p><span class="strong"><strong>void *<a class="st-synopsis" href="man_coap_async_get_app_data.html#coap_async_get_app_data" target="_self">coap_async_get_app_data</a>(const coap_async_t *<span class="emphasis"><em>async</em></span>);</strong></span></p><p>For specific (D)TLS library support, link with
<span class="strong"><strong>-lcoap-3-notls</strong></span>, <span class="strong"><strong>-lcoap-3-gnutls</strong></span>,
<span class="strong"><strong>-lcoap-3-openssl</strong></span>, <span class="strong"><strong>-lcoap-3-mbedtls</strong></span>
or <span class="strong"><strong>-lcoap-3-tinydtls</strong></span>.   Otherwise, link with
<span class="strong"><strong>-lcoap-3</strong></span> to get the default (D)TLS library support.</p></div><div class="refsect1"><a id="_description"></a><h2>DESCRIPTION</h2><p>CoAP server responses can be piggybacked
("<a class="ulink" href="https://rfc-editor.org/rfc/rfc7252#section-5.2.1" target="_top">RFC7252 5.2.1. Piggybacked</a>")
or separate
("<a class="ulink" href="https://rfc-editor.org/rfc/rfc7252#section-5.2.2" target="_top">RFC7252 5.2.2. Separate</a>").</p><p>For piggybacked responses, the response packet contains both the status and
any data.</p><p>For separate responses, there is an initial empty ACK response (Confirmable
only - to stop the client re-transmitting the request) followed at a later time
by a packet containing the status and any data.</p><p>Usually responses are piggybacked, but this man page focuses on a mechanism
for providing separate (async) support.</p><p><span class="strong"><strong>NOTE:</strong></span> If a server is providing Proxy support, then the server code should
return from the request handler with no response code set (i.e. respond with
empty ACK) and then send back the response as provided by the upstream server
when received, so no need to use the async support.</p></div><div class="refsect1"><a id="_functions"></a><h2>FUNCTIONS</h2><p><span class="strong"><strong>Function: <a class="st-desc" href="man_coap_async_is_supported.html#coap_async_is_supported" target="_self">coap_async_is_supported</a>()</strong></span></p><p>The <span class="strong"><strong><a class="st-desc" href="man_coap_async_is_supported.html#coap_async_is_supported" target="_self">coap_async_is_supported</a></strong></span>() function is used to determine if there is
async support or not compiled into libcoap.</p><p><span class="strong"><strong>Function: <a class="st-desc" href="man_coap_register_async.html#coap_register_async" target="_self">coap_register_async</a>()</strong></span></p><p>The <span class="strong"><strong><a class="st-desc" href="man_coap_register_async.html#coap_register_async" target="_self">coap_register_async</a></strong></span>() function is used to set up an asynchronous delayed
request for the <span class="emphasis"><em>request</em></span> PDU associated with the <span class="emphasis"><em>session</em></span>. The
application request handler will get called with a copy of <span class="emphasis"><em>request</em></span> after
<span class="emphasis"><em>delay</em></span> ticks which will then cause a response to be sent.  If <span class="emphasis"><em>delay</em></span> is 0,
then the application request handler will not get called until
<span class="strong"><strong><a class="st-desc" href="man_coap_async_trigger.html#coap_async_trigger" target="_self">coap_async_trigger</a></strong></span>() or <span class="strong"><strong><a class="st-desc" href="man_coap_async_set_delay.html#coap_async_set_delay" target="_self">coap_async_set_delay</a></strong></span>() is called.</p><p><span class="strong"><strong>Function: <a class="st-desc" href="man_coap_async_trigger.html#coap_async_trigger" target="_self">coap_async_trigger</a>()</strong></span></p><p>The <span class="strong"><strong><a class="st-desc" href="man_coap_async_trigger.html#coap_async_trigger" target="_self">coap_async_trigger</a></strong></span>() function is used to expire the delay for the
<span class="emphasis"><em>async</em></span> definition, so the application request handler is almost
immediately called.</p><p><span class="strong"><strong>Function: <a class="st-desc" href="man_coap_async_set_delay.html#coap_async_set_delay" target="_self">coap_async_set_delay</a>()</strong></span></p><p>The <span class="strong"><strong><a class="st-desc" href="man_coap_async_set_delay.html#coap_async_set_delay" target="_self">coap_async_set_delay</a></strong></span>() function is used to update the remaining <span class="emphasis"><em>delay</em></span>
before the application request handler is called for the <span class="emphasis"><em>async</em></span> definition. If
<span class="emphasis"><em>delay</em></span> is set to 0, then the application request handler will not get called.</p><p>An example of usage here is <span class="strong"><strong><a class="st-desc" href="man_coap_register_async.html#coap_register_async" target="_self">coap_register_async</a></strong></span>() sets <span class="emphasis"><em>delay</em></span> to 0, and
then when the response is ready at an indeterminate point in the future,
<span class="strong"><strong><a class="st-desc" href="man_coap_async_set_delay.html#coap_async_set_delay" target="_self">coap_async_set_delay</a></strong></span>() is called setting <span class="emphasis"><em>delay</em></span> to 1. Alternatively,
<span class="strong"><strong><a class="st-desc" href="man_coap_async_trigger.html#coap_async_trigger" target="_self">coap_async_trigger</a></strong></span>() can be called.</p><p><span class="strong"><strong>Function: <a class="st-desc" href="man_coap_free_async.html#coap_free_async" target="_self">coap_free_async</a>()</strong></span></p><p>The <span class="strong"><strong><a class="st-desc" href="man_coap_free_async.html#coap_free_async" target="_self">coap_free_async</a></strong></span>() function is used to delete an <span class="emphasis"><em>async</em></span> definition.</p><p><span class="strong"><strong><a class="anchor" id="coap_find_async"></a>Function: <a href="man_coap_find_async.html#coap_find_async" target="_self"><span class="man-highlight">coap_find_async</span></a>()</strong></span></p><p>The <span class="strong"><strong><a class="st-desc" href="man_coap_find_async.html#coap_find_async" target="_self"><span class="man-highlight">coap_find_async</span></a></strong></span>() function is used to determine if there is an async
definition based on the <span class="emphasis"><em>session</em></span> and token <span class="emphasis"><em>token</em></span>.</p><p><span class="strong"><strong>Function: <a class="st-desc" href="man_coap_async_set_app_data.html#coap_async_set_app_data" target="_self">coap_async_set_app_data</a>()</strong></span></p><p>The <span class="strong"><strong><a class="st-desc" href="man_coap_async_set_app_data.html#coap_async_set_app_data" target="_self">coap_async_set_app_data</a></strong></span>() function is used to add in user defined
<span class="emphasis"><em>app_data</em></span> to the <span class="emphasis"><em>async</em></span> definition.  It is the responsibility of the
application to release this data if appropriate.  This would usually be done
when the application request handler is called under <span class="emphasis"><em>async</em></span> control.</p><p><span class="strong"><strong>Function: <a class="st-desc" href="man_coap_async_get_app_data.html#coap_async_get_app_data" target="_self">coap_async_get_app_data</a>()</strong></span></p><p>The <span class="strong"><strong><a class="st-desc" href="man_coap_async_get_app_data.html#coap_async_get_app_data" target="_self">coap_async_get_app_data</a></strong></span>() function is used to retrieve any defined
application data from the  <span class="emphasis"><em>async</em></span> definition.</p></div><div class="refsect1"><a id="_return_values"></a><h2>RETURN VALUES</h2><p><span class="strong"><strong><a class="st-desc" href="man_coap_async_is_supported.html#coap_async_is_supported" target="_self">coap_async_is_supported</a></strong></span>() returns 1 if support is available, 0 otherwise.</p><p><span class="strong"><strong><a class="st-desc" href="man_coap_register_async.html#coap_register_async" target="_self">coap_register_async</a></strong></span>() and <span class="strong"><strong><a class="st-desc" href="man_coap_find_async.html#coap_find_async" target="_self"><span class="man-highlight">coap_find_async</span></a></strong></span>() return a pointer to an async
definition or NULL if there is an error.</p><p><span class="strong"><strong><a class="st-desc" href="man_coap_async_get_app_data.html#coap_async_get_app_data" target="_self">coap_async_get_app_data</a></strong></span>() returns a pointer to the user defined data.</p></div><div class="refsect1"><a id="_examples"></a><h2>EXAMPLES</h2><p><span class="strong"><strong>CoAP Server Non-Encrypted Setup</strong></span></p><pre class="programlisting">#include &lt;coap3/coap.h&gt;

/*
 * This example is used to demonstrate how to set up and use a "separate"
 * response (empty ACK followed by data response at a later stage).
 */
static void
hnd_get_with_delay(coap_session_t *session,
              coap_resource_t *resource,
              coap_pdu_t *request,
              coap_string_t *query,
              coap_pdu_t *response) {
  unsigned long delay = 5;
  size_t size;
  coap_async_t *async;
  coap_bin_const_t token = <a href="man_coap_pdu_get_token.html#coap_pdu_get_token" target="_self">coap_pdu_get_token</a>(request);

  /*
   * See if this is the initial, or delayed request
   */

  async = <a href="man_coap_find_async.html#coap_find_async" target="_self"><span class="man-highlight">coap_find_async</span></a>(session, token);
  if (!async) {
    /* Set up an async request to trigger delay in the future */
    if (query) {
      const uint8_t *p = query-&gt;s;

      delay = 0;
      for (size = query-&gt;length; size; --size, ++p)
        delay = delay * 10 + (*p - '0');
      if (delay == 0) {
        <a href="man_coap_log_info.html#coap_log_info" target="_self">coap_log_info</a>("async: delay of 0 not supported\n");
        <a href="man_coap_pdu_set_code.html#coap_pdu_set_code" target="_self">coap_pdu_set_code</a>(response, COAP_RESPONSE_CODE_BAD_REQUEST);
        return;
      }
    }
    async = <a href="man_coap_register_async.html#coap_register_async" target="_self">coap_register_async</a>(session,
                                request,
                                COAP_TICKS_PER_SECOND * delay);
    if (async == NULL) {
      <a href="man_coap_pdu_set_code.html#coap_pdu_set_code" target="_self">coap_pdu_set_code</a>(response, COAP_RESPONSE_CODE_SERVICE_UNAVAILABLE);
      return;
    }
    /*
     * Not setting response code will cause empty ACK to be sent
     * if Confirmable
     */
    return;
  }
  /* async is set up, so this is the delayed request */

  /* remove any stored app data associated with 'async' here */

  /* Send back the appropriate data */
  <a href="man_coap_add_data_large_response.html#coap_add_data_large_response" target="_self">coap_add_data_large_response</a>(resource, session, request, response,
                               query, COAP_MEDIATYPE_TEXT_PLAIN, -1, 0, 4,
                               (const uint8_t *)"done", NULL, NULL);
  <a href="man_coap_pdu_set_code.html#coap_pdu_set_code" target="_self">coap_pdu_set_code</a>(response, COAP_RESPONSE_CODE_CONTENT);

  /* async is automatically removed by libcoap on return from this handler */
}</pre></div><div class="refsect1"><a id="_see_also"></a><h2>SEE ALSO</h2><p><span class="strong"><strong><a class="st-desc" href="man_coap_handler.html#coap_handler" target="_self">coap_handler</a></strong></span>(3)</p></div><div class="refsect1"><a id="_further_information"></a><h2>FURTHER INFORMATION</h2><p>See</p><p>"<a class="ulink" href="https://rfc-editor.org/rfc/rfc7252" target="_top">RFC7252: The Constrained Application Protocol (CoAP)</a>"</p><p>for further information.</p></div><div class="refsect1"><a id="_bugs"></a><h2>BUGS</h2><p>Please report bugs on the mailing list for libcoap:
<a class="ulink" href="mailto:libcoap-developers@lists.sourceforge.net" target="_top">libcoap-developers@lists.sourceforge.net</a> or raise an issue on GitHub at
<a class="ulink" href="https://github.com/obgm/libcoap/issues" target="_top">https://github.com/obgm/libcoap/issues</a></p></div><div class="refsect1"><a id="_authors"></a><h2>AUTHORS</h2><p>The libcoap project &lt;<a class="ulink" href="mailto:libcoap-developers@lists.sourceforge.net" target="_top">libcoap-developers@lists.sourceforge.net</a>&gt;</p></div></div></body></html> coap_find_async(3)</p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Thu Sep 7 2023 15:01:17 for libcoap by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.4 </li>
  </ul>
</div>
</body>
</html>
